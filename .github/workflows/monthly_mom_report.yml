name: Monthly-MoM-Report

on:
  schedule:
    - cron: "30 3 1 * *"   # 9:00 AM IST on 1st of every month
  workflow_dispatch:

jobs:
  generate_report:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install Dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Generate Monthly Report PDF
        env:
          SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASS: ${{ secrets.SMTP_PASS }}
          OWNER_EMAIL: ${{ secrets.OWNER_EMAIL }}
        run: |
          echo "ðŸ“„ Generating Monthly Report..."
          python3 monthly_summary_pdf.py
          echo "âœ… PDF generated"

      - name: Email PDF
        env:
          SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASS: ${{ secrets.SMTP_PASS }}
        run: |
          echo "ðŸ“§ Emailing Monthly Report..."
          python3 - << 'EOF'
          import smtplib
          from email.mime.multipart import MIMEMultipart
          from email.mime.base import MIMEBase
          from email.mime.text import MIMEText
          from email import encoders
          import os

          sender = os.getenv("SMTP_USER")
          password = os.getenv("SMTP_PASS")
          smtp_server = os.getenv("SMTP_SERVER")
          smtp_port = int(os.getenv("SMTP_PORT"))
          receiver = "praveen.chaudhary@koenig-solutions.com"

          msg = MIMEMultipart()
          msg["From"] = sender
          msg["To"] = receiver
          msg["Subject"] = "ðŸ“Š Monthly MoM Summary Report"

          body = """Dear Team,

Please find attached the Monthly MoM Summary Report.

Best regards,
Koenig MoM Automation"""
          
          msg.attach(MIMEText(body, "plain"))

          filename = "Monthly_MoM_Summary.pdf"
          try:
              with open(filename, "rb") as f:
                  part = MIMEBase("application", "octet-stream")
                  part.set_payload(f.read())
                  encoders.encode_base64(part)
                  part.add_header("Content-Disposition", f"attachment; filename={filename}")
                  msg.attach(part)
          except FileNotFoundError:
              print(f"âš ï¸  {filename} not found")

          try:
              server = smtplib.SMTP(smtp_server, smtp_port)
              server.starttls()
              server.login(sender, password)
              server.sendmail(sender, receiver, msg.as_string())
              server.quit()
              print(f"âœ… Emailed to {receiver}")
          except Exception as e:
              print(f"âŒ Email failed: {e}")
              raise
          EOF
