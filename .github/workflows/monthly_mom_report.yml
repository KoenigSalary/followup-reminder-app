name: Monthly-MoM-Report

on:
  schedule:
    - cron: "30 3 1 * *"   # Runs at 9:00 AM IST on 1st of every month
  workflow_dispatch:

jobs:
  generate_report:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install Dependencies
        run: |
          pip install -r requirements.txt
          pip install reportlab matplotlib pandas openpyxl

      - name: Generate Monthly MoM Report PDF
        run: |
          python3 monthly_summary_pdf.py

      - name: Email PDF to Manager
        env:
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
        run: |
          python3 - << 'EOF'
          import smtplib
          from email.mime.multipart import MIMEMultipart
          from email.mime.base import MIMEBase
          from email.mime.text import MIMEText
          from email import encoders
          import os

          sender = os.getenv("EMAIL_USER")
          password = os.getenv("EMAIL_PASS")
          receiver = "praveen.chaudhary@koenig-solutions.com"  # TEST EMAIL

          msg = MIMEMultipart()
          msg["From"] = sender
          msg["To"] = receiver
          msg["Subject"] = "Monthly MoM Summary Report"

          body = "Dear Team,\n\nPlease find attached the Monthly MoM Summary Report.\n\nRegards,\nMoM Automation Bot"
          msg.attach(MIMEText(body, "plain"))

          filename = "Monthly_MoM_Summary.pdf"
          attachment = open(filename, "rb")

          part = MIMEBase("application", "octet-stream")
          part.set_payload(attachment.read())
          encoders.encode_base64(part)
          part.add_header("Content-Disposition", f"attachment; filename={filename}")

          msg.attach(part)

          server = smtplib.SMTP("smtp.office365.com", 587)
          server.starttls()
          server.login(sender, password)
          server.sendmail(sender, receiver, msg.as_string())
          server.quit()
          EOF
